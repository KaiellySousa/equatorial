<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizar Notas - Equatorial Piauí</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .filters {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filters select, .filters input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .notas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .nota-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      border-left: 4px solid #2d6cdf;
    }
    
    .nota-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .nota-numero {
      font-size: 18px;
      font-weight: 600;
      color: #2d6cdf;
    }
    
    .nota-data {
      font-size: 12px;
      color: #666;
    }
    
    .nota-info {
      margin-bottom: 10px;
    }
    
    .nota-info strong {
      color: #333;
      display: inline-block;
      width: 100px;
    }
    
    .nota-foto {
      margin-top: 15px;
      text-align: center;
    }
    
    .nota-foto img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    
    .usuario-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .atividade-info {
      background: #e3f2fd;
      padding: 8px;
      border-radius: 5px;
      margin-top: 8px;
      font-size: 12px;
      border-left: 3px solid #2196f3;
    }
    
    .usuario-ativo {
      color: #4caf50;
      font-weight: 600;
    }
    
    .usuario-visualizando {
      color: #ff9800;
      font-weight: 600;
    }
    
    .status-indicador {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .status-online { background: #4caf50; }
    .status-visualizando { background: #ff9800; }
    .status-offline { background: #ccc; }
    
    .atividade-lista {
      max-height: 100px;
      overflow-y: auto;
      background: #f5f5f5;
      padding: 5px;
      border-radius: 3px;
      margin-top: 5px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-aprovado { background: #d4edda; color: #155724; }
    .status-reprovado { background: #f8d7da; color: #721c24; }
    .status-pendente { background: #fff3cd; color: #856404; }
    
    .dificuldade-facil { color: #28a745; }
    .dificuldade-medio { color: #ffc107; }
    .dificuldade-dificil { color: #dc3545; }
    
    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }
    
    .stats {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: 600;
      color: #2d6cdf;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo">
      <img src="assets/imagens/energia-equatorial-removebg-preview.png" alt="Equatorial Energia" />
    </div>
    <nav>
      <ul>
        <li><a href="home.html"><strong>Home</strong></a></li>
        <li><a href="formulario.html"><strong>Formulário</strong></a></li>
        <li><a href="historico.html"><strong>Histórico</strong></a></li>
        <li><a href="monitor-atividade.html"><strong>Monitor</strong></a></li>
        <li><button id="logout" class="btn-logout">Sair</button></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <h1 style="text-align: center; margin: 30px 0; color: #2d6cdf;">Visualizar Notas Registradas</h1>
    
    <!-- Atividade em Tempo Real -->
    <div class="stats" id="atividadeTempoReal" style="background: #e8f5e8; border-left: 4px solid #4caf50;">
      <div class="stat-item">
        <div class="stat-number" id="usuariosOnline">0</div>
        <div class="stat-label">Usuários Online</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="notasSendoVisualizadas">0</div>
        <div class="stat-label">Notas Sendo Visualizadas</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="atividadeRecente">0</div>
        <div class="stat-label">Atividades Recentes</div>
      </div>
    </div>

    <!-- Estatísticas -->
    <div class="stats" id="stats">
      <div class="stat-item">
        <div class="stat-number" id="totalNotas">0</div>
        <div class="stat-label">Total de Notas</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="notasAprovadas">0</div>
        <div class="stat-label">Aprovadas</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="notasPendentes">0</div>
        <div class="stat-label">Pendentes</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="usuariosAtivos">0</div>
        <div class="stat-label">Usuários Ativos</div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <select id="filtroUsuario">
        <option value="">Todos os usuários</option>
      </select>
      
      <select id="filtroStatus">
        <option value="">Todos os status</option>
        <option value="Aprovado">Aprovado</option>
        <option value="Reprovado">Reprovado</option>
        <option value="Pendente">Pendente</option>
      </select>
      
      <select id="filtroDificuldade">
        <option value="">Todas as dificuldades</option>
        <option value="Fácil">Fácil</option>
        <option value="Médio">Médio</option>
        <option value="Difícil">Difícil</option>
      </select>
      
      <input type="text" id="buscaNota" placeholder="Buscar por instalação ou cliente..." style="flex: 1; min-width: 200px;">
    </div>

    <!-- Grid de Notas -->
    <div class="notas-grid" id="notasGrid">
      <div class="no-data">Carregando notas...</div>
    </div>
  </div>

  <script>
    // Autenticação
    const usuario = localStorage.getItem("usuario");
    if (!usuario) window.location.href = "login.html";

    // Logout
    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('usuario');
      window.location.href = 'login.html';
    });

    let todasNotas = [];
    let notasFiltradas = [];
    let atividadeUsuarios = {};
    let usuariosOnline = new Set();
    let notasSendoVisualizadas = new Set();

    // Carregar notas do localStorage
    function carregarNotas() {
      const notasSalvas = localStorage.getItem('notasRegistradas');
      if (notasSalvas) {
        todasNotas = JSON.parse(notasSalvas);
        notasFiltradas = [...todasNotas];
        renderizarNotas();
        atualizarEstatisticas();
        popularFiltros();
      } else {
        document.getElementById('notasGrid').innerHTML = '<div class="no-data">Nenhuma nota registrada ainda.</div>';
      }
    }

    // Renderizar notas
    function renderizarNotas() {
      const grid = document.getElementById('notasGrid');
      
      if (notasFiltradas.length === 0) {
        grid.innerHTML = '<div class="no-data">Nenhuma nota encontrada com os filtros aplicados.</div>';
        return;
      }

      grid.innerHTML = notasFiltradas.map(nota => {
        const notaId = nota.instalacao;
        const visualizadores = atividadeUsuarios[notaId] || [];
        const isSendoVisualizada = notasSendoVisualizadas.has(notaId);
        
        return `
        <div class="nota-card" data-nota-id="${notaId}">
          <div class="nota-header">
            <div class="nota-numero">Nota #${nota.instalacao}</div>
            <div class="nota-data">${formatarData(nota.dataRegistro)}</div>
          </div>
          
          <div class="nota-info">
            <strong>Regional:</strong> ${nota.regional}<br>
            <strong>Cliente:</strong> ${nota.cliente}<br>
            <strong>STC:</strong> <span class="status-badge status-${nota.stc.toLowerCase()}">${nota.stc}</span><br>
            <strong>Dificuldade:</strong> <span class="dificuldade-${nota.dificuldade.toLowerCase()}">${nota.dificuldade}</span><br>
            <strong>Status:</strong> ${nota.status}
          </div>
          
          ${nota.foto ? `
            <div class="nota-foto">
              <img src="${nota.foto}" alt="Foto da nota" onclick="abrirFoto('${nota.foto}')">
            </div>
          ` : ''}
          
          <div class="usuario-info">
            <strong>Registrado por:</strong> ${nota.usuario}
          </div>
          
          <div class="atividade-info">
            <strong>Atividade:</strong>
            ${isSendoVisualizada ? `
              <span class="status-indicador status-visualizando"></span>
              <span class="usuario-visualizando">Sendo visualizada agora</span>
            ` : `
              <span class="status-indicador status-offline"></span>
              <span>Nenhuma atividade recente</span>
            `}
            ${visualizadores.length > 0 ? `
              <div class="atividade-lista">
                <strong>Últimos visualizadores:</strong><br>
                ${visualizadores.slice(-3).map(v => `
                  <span class="status-indicador status-online"></span>
                  ${v.usuario} - ${formatarData(v.timestamp)}
                `).join('<br>')}
              </div>
            ` : ''}
          </div>
        </div>
      `;
      }).join('');
    }

    // Atualizar estatísticas
    function atualizarEstatisticas() {
      const total = todasNotas.length;
      const aprovadas = todasNotas.filter(n => n.stc === 'Aprovado').length;
      const pendentes = todasNotas.filter(n => n.stc === 'Pendente').length;
      const usuariosUnicos = new Set(todasNotas.map(n => n.usuario)).size;

      document.getElementById('totalNotas').textContent = total;
      document.getElementById('notasAprovadas').textContent = aprovadas;
      document.getElementById('notasPendentes').textContent = pendentes;
      document.getElementById('usuariosAtivos').textContent = usuariosUnicos;
    }

    // Popular filtros
    function popularFiltros() {
      const usuarios = [...new Set(todasNotas.map(n => n.usuario))];
      const selectUsuario = document.getElementById('filtroUsuario');
      
      selectUsuario.innerHTML = '<option value="">Todos os usuários</option>' +
        usuarios.map(u => `<option value="${u}">${u}</option>`).join('');
    }

    // Aplicar filtros
    function aplicarFiltros() {
      const usuario = document.getElementById('filtroUsuario').value;
      const status = document.getElementById('filtroStatus').value;
      const dificuldade = document.getElementById('filtroDificuldade').value;
      const busca = document.getElementById('buscaNota').value.toLowerCase();

      notasFiltradas = todasNotas.filter(nota => {
        const matchUsuario = !usuario || nota.usuario === usuario;
        const matchStatus = !status || nota.stc === status;
        const matchDificuldade = !dificuldade || nota.dificuldade === dificuldade;
        const matchBusca = !busca || 
          nota.instalacao.toLowerCase().includes(busca) ||
          nota.cliente.toLowerCase().includes(busca);

        return matchUsuario && matchStatus && matchDificuldade && matchBusca;
      });

      renderizarNotas();
    }

    // Event listeners para filtros
    document.getElementById('filtroUsuario').addEventListener('change', aplicarFiltros);
    document.getElementById('filtroStatus').addEventListener('change', aplicarFiltros);
    document.getElementById('filtroDificuldade').addEventListener('change', aplicarFiltros);
    document.getElementById('buscaNota').addEventListener('input', aplicarFiltros);

    // Funções auxiliares
    function formatarData(dataISO) {
      const data = new Date(dataISO);
      return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    }

    function abrirFoto(src) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; align-items: center;
        justify-content: center; z-index: 1000; cursor: pointer;
      `;
      modal.innerHTML = `<img src="${src}" style="max-width: 90%; max-height: 90%; border-radius: 10px;">`;
      modal.onclick = () => document.body.removeChild(modal);
      document.body.appendChild(modal);
    }

    // Sistema de rastreamento de atividade
    function registrarVisualizacao(notaId) {
      const timestamp = new Date().toISOString();
      const atividade = {
        usuario: usuario,
        timestamp: timestamp,
        acao: 'visualizando'
      };
      
      if (!atividadeUsuarios[notaId]) {
        atividadeUsuarios[notaId] = [];
      }
      
      // Adicionar atividade
      atividadeUsuarios[notaId].push(atividade);
      
      // Manter apenas as últimas 10 atividades
      if (atividadeUsuarios[notaId].length > 10) {
        atividadeUsuarios[notaId] = atividadeUsuarios[notaId].slice(-10);
      }
      
      // Marcar como sendo visualizada
      notasSendoVisualizadas.add(notaId);
      
      // Salvar no localStorage
      localStorage.setItem('atividadeUsuarios', JSON.stringify(atividadeUsuarios));
      
      // Atualizar interface
      atualizarAtividadeTempoReal();
    }
    
    function pararVisualizacao(notaId) {
      notasSendoVisualizadas.delete(notaId);
      atualizarAtividadeTempoReal();
    }
    
    function atualizarAtividadeTempoReal() {
      // Simular usuários online (em um sistema real, isso viria do servidor)
      const usuariosUnicos = new Set(todasNotas.map(n => n.usuario));
      usuariosOnline = usuariosUnicos;
      
      document.getElementById('usuariosOnline').textContent = usuariosOnline.size;
      document.getElementById('notasSendoVisualizadas').textContent = notasSendoVisualizadas.size;
      
      // Contar atividades recentes (últimas 24h)
      const agora = new Date();
      const ontem = new Date(agora.getTime() - 24 * 60 * 60 * 1000);
      
      let atividadesRecentes = 0;
      Object.values(atividadeUsuarios).forEach(atividades => {
        atividadesRecentes += atividades.filter(a => new Date(a.timestamp) > ontem).length;
      });
      
      document.getElementById('atividadeRecente').textContent = atividadesRecentes;
    }
    
    // Rastrear quando o usuário visualiza uma nota
    function adicionarRastreamentoVisualizacao() {
      const cards = document.querySelectorAll('.nota-card');
      cards.forEach(card => {
        const notaId = card.getAttribute('data-nota-id');
        
        // Observer para detectar quando a nota entra na tela
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              registrarVisualizacao(notaId);
            } else {
              pararVisualizacao(notaId);
            }
          });
        }, { threshold: 0.5 });
        
        observer.observe(card);
      });
    }
    
    // Carregar atividade salva
    function carregarAtividade() {
      const atividadeSalva = localStorage.getItem('atividadeUsuarios');
      if (atividadeSalva) {
        atividadeUsuarios = JSON.parse(atividadeSalva);
      }
    }
    
    // Atualizar atividade a cada 30 segundos
    setInterval(() => {
      atualizarAtividadeTempoReal();
    }, 30000);

    // Inicializar
    carregarAtividade();
    carregarNotas();
    
    // Adicionar rastreamento após renderizar
    setTimeout(() => {
      adicionarRastreamentoVisualizacao();
    }, 1000);
  </script>
</body>
</html>
